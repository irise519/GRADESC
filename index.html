<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多用户成绩与GPA计算器 (云同步增强版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
            background-color: #f8f9fa;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .form-input {
            border: 1px solid #d1d5db;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-danger-outline { background-color: transparent; color: #ef4444; border-color: #ef4444; }
        .btn-danger-outline:hover { background-color: #fef2f2; color: #dc2626; }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>
    <div id="error-container" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>

    <!-- 登录视图 -->
    <div id="login-view" class="max-w-md mx-auto text-center mt-20 fade-in">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">GRADESC</h1>
        <p class="text-gray-500 mt-3 text-lg mb-8">您的私人成绩与GPA智能管家</p>
        <div class="card p-8">
            <p class="text-gray-600 mb-6">使用您的 Google 账号登录以开始记录和管理您的成绩</p>
            <button id="login-btn" class="btn btn-primary w-full">登录</button>
        </div>
    </div>

    <!-- 主应用视图 -->
    <div id="app-view" class="hidden">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-4">
                <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="头像">
                <span id="user-name" class="text-xl font-semibold text-gray-700"></span>
            </div>
            <button id="logout-btn" class="btn btn-secondary">登出</button>
        </div>

        <div class="card p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">学生管理</h2>
                <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                    <select id="student-selector" class="form-input p-2 rounded-md"></select>
                    <button id="add-student-btn" class="btn btn-primary">+ 添加学生</button>
                    <button id="add-semester-btn" class="btn btn-primary">+ 添加学期</button>
                    <div class="relative">
                        <button type="button" id="export-menu-btn" class="inline-flex w-full justify-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" aria-expanded="false" aria-haspopup="true">
                            导出
                            <svg class="-mr-1 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="export-menu-options" class="hidden absolute right-0 z-10 mt-2 w-40 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="export-menu-btn">
                            <div class="py-1" role="none">
                                <button id="export-xlsx-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">导出为 Excel (.xlsx)</button>
                                <button id="export-json-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">导出为 JSON (.json)</button>
                            </div>
                        </div>
                    </div>
                    <button id="clear-all-btn" class="btn btn-danger-outline">清空所有数据</button>
                </div>
            </div>
            <div id="status-display" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <div id="student-content-container">
            <template id="student-content-template">
                <div class="space-y-12"></div>
            </template>
        </div>

        <!-- 学期模板 -->
        <div class="hidden">
            <template id="semester-template">
                <div class="semester-section card p-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6">
                        <h2 class="semester-name-input text-2xl font-bold text-gray-800"></h2>
                        <button class="remove-semester-btn btn btn-danger-outline">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <!-- 修改点1: 将 grid-cols-1 lg:grid-cols-2 改为 grid-cols-1，确保每门课程独占一行 -->
                    <div class="courses-container grid grid-cols-1 gap-8"></div>
                    <div class="mt-8 p-6 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="font-semibold text-gray-600">学期总GPA</div>
                            <span class="semester-gpa-display text-3xl font-extrabold text-green-600">N/A</span>
                        </div>
                        <!-- 修改点2: 将“学期加权总分”改为“学期总分” -->
                        <div class="flex justify-between items-center">
                            <div class="font-semibold text-gray-600">学期总分 (百分制)</div>
                            <span class="semester-weighted-score-display text-3xl font-extrabold text-blue-600">N/A</span>
                        </div>
                    </div>
                </div>
            </template>

            <!-- 课程模板 -->
            <template id="course-template">
                <div class="card p-6 course-card fade-in">
                    <div class="flex justify-between items-start mb-5">
                        <input type="text" class="course-name-input text-2xl font-bold text-gray-800 bg-transparent border-b-2 border-transparent focus:border-blue-400 outline-none w-2/3 p-0" placeholder="输入课程名称...">
                        <button class="remove-course-btn text-gray-400 hover:text-red-500 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 100 2h2a1 1 0 100-2h-2zM4 8a4 4 0 108 0 4 4 0 00-8 0zm2-3a2 2 0 114 0 2 2 0 01-4 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <!-- 修改点3: 新增“学期总分权重”输入框 -->
                        <div>
                            <label class="text-sm font-medium text-gray-500">学期总分权重 (%)</label>
                            <input type="number" min="0" max="100" step="0.5" placeholder="例如: 30" class="course-credits-input form-input w-full p-2 mt-1 rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">目标分</label>
                            <input type="number" min="0" max="100" placeholder="90" class="target-grade-input form-input w-full p-2 mt-1 rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">权重和</label>
                            <span class="total-weight-display font-bold text-lg p-2 block mt-1">0%</span>
                        </div>
                    </div>
                    <table class="w-full assignments-table">
                        <thead>
                            <tr class="text-sm text-gray-500 uppercase tracking-wider">
                                <th class="text-left p-2">评分项目</th>
                                <th class="text-left p-2">类型</th>
                                <th class="text-left p-2">权重</th>
                                <th class="text-left p-2">得分</th>
                                <th class="text-left p-2">满分</th>
                                <th class="p-2"></th>
                            </tr>
                        </thead>
                        <tbody class="assignments-container"></tbody>
                    </table>
                    <button class="add-assignment-btn mt-4 w-full btn btn-secondary">+ 添加作业/考试</button>
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="text-md font-semibold text-gray-600">当前总分:</h3>
                            <p class="current-grade-display text-2xl font-bold text-blue-600">N/A</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <h3 class="text-md font-semibold text-gray-600">目标达成分析:</h3>
                            <p class="target-analysis-display text-sm font-semibold text-gray-500 text-right">输入目标分以分析</p>
                        </div>
                        <!-- 修改点4: 新增“对学期总分贡献”显示 -->
                        <div class="flex justify-between items-center">
                            <h3 class="text-md font-semibold text-gray-600">对学期总分贡献:</h3>
                            <p class="contribution-display text-xl font-bold text-green-600">0 分</p>
                        </div>
                    </div>
                </div>
            </template>

            <!-- 评分项目模板 -->
            <template id="assignment-template">
                <tr class="assignment-row border-b border-gray-100 last:border-b-0">
                    <td class="p-2">
                        <input type="text" placeholder="例如: 期中论文" class="assignment-name-input w-full bg-transparent outline-none p-1">
                    </td>
                    <td class="p-2">
                        <select class="assignment-type-input w-full bg-transparent outline-none p-1">
                            <option value="">请选择</option>
                            <option value="作业">作业</option>
                            <option value="小测验">小测验</option>
                            <option value="期中考试">期中考试</option>
                            <option value="期末考试">期末考试</option>
                            <option value="项目">项目</option>
                            <option value="出勤">出勤</option>
                            <option value="其他">其他</option>
                        </select>
                    </td>
                    <td class="p-2">
                        <input type="number" min="0" placeholder="20" class="assignment-weight-input w-20 bg-transparent outline-none p-1 text-center">
                    </td>
                    <td class="p-2">
                        <input type="number" min="0" placeholder="-" class="assignment-score-input w-24 bg-transparent outline-none p-1 text-center">
                    </td>
                    <td class="p-2">
                        <input type="number" min="0" value="100" class="assignment-max-score-input w-24 bg-transparent outline-none p-1 text-center">
                    </td>
                    <td class="p-2 text-center">
                        <button class="remove-assignment-btn text-gray-400 hover:text-red-500 transition">×</button>
                    </td>
                </tr>
            </template>
        </div>

        <!-- GPA说明弹窗 -->
        <div id="gpa-info-popup" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
            <div class="card p-8 max-w-md w-full fade-in">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">绩点 (GPA) 换算标准</h2>
                <ul class="space-y-2 text-gray-600">
                    <li class="flex justify-between"><span>95-100分</span><span class="font-semibold text-green-600">4.0 绩点</span></li>
                    <li class="flex justify-between"><span>90-94分</span><span class="font-semibold text-green-600">3.7 绩点</span></li>
                    <li class="flex justify-between"><span>85-89分</span><span class="font-semibold text-blue-600">3.3 绩点</span></li>
                    <li class="flex justify-between"><span>80-84分</span><span class="font-semibold text-blue-600">3.0 绩点</span></li>
                    <li class="flex justify-between"><span>75-79分</span><span class="font-semibold text-yellow-600">2.7 绩点</span></li>
                    <li class="flex justify-between"><span>70-74分</span><span class="font-semibold text-yellow-600">2.3 绩点</span></li>
                    <li class="flex justify-between"><span>65-69分</span><span class="font-semibold text-orange-600">2.0 绩点</span></li>
                    <li class="flex justify-between"><span>60-64分</span><span class="font-semibold text-red-600">1.7 绩点</span></li>
                    <li class="flex justify-between"><span>60分以下</span><span class="font-semibold text-red-600">0.0 绩点</span></li>
                </ul>
                <button onclick="document.getElementById('gpa-info-popup').style.display='none'" class="btn btn-primary w-full mt-8">我明白了</button>
            </div>
        </div>

        <!-- 确认模态框 -->
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="card p-8 max-w-md w-full fade-in">
                <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-gray-800">确认操作</h3>
                <p id="confirm-modal-body" class="mb-8 text-gray-600">您确定要继续吗？此操作无法撤销。</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-modal-cancel-btn" class="btn btn-secondary">取消</button>
                    <button id="confirm-modal-confirm-btn" class="btn btn-danger">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // === Firebase 初始化 ===
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBvYKqLZ1Z6uJZ3X7vZ6uJZ3X7vZ6uJZ3X7",
            authDomain: "grades-tracker-9d3c1.firebaseapp.com",
            projectId: "grades-tracker-9d3c1",
            storageBucket: "grades-tracker-9d3c1.appspot.com",
            messagingSenderId: "327803457841",
            appId: "1:327803457841:web:7824768330715481570915"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        let currentUser = null;
        let localStudentsData = [];
        let selectedStudentId = null;
        let studentsUnsubscribe = null;

        const ui = {
            loginView: document.getElementById('login-view'),
            appView: document.getElementById('app-view'),
            loadingOverlay: document.getElementById('loading-overlay'),
            userName: document.getElementById('user-name'),
            userAvatar: document.getElementById('user-avatar'),
            studentSelector: document.getElementById('student-selector'),
            studentContentContainer: document.getElementById('student-content-container'),
            confirmModal: {
                el: document.getElementById('confirm-modal'),
                title: document.getElementById('confirm-modal-title'),
                body: document.getElementById('confirm-modal-body'),
                confirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
            },
            overall: {
                gpa: document.getElementById('overall-gpa-display'),
                score: document.getElementById('overall-weighted-score-display'),
            },
            exportMenu: {
                btn: document.getElementById('export-menu-btn'),
                options: document.getElementById('export-menu-options'),
            }
        };

        // === 错误处理与状态更新 ===
        function showError(message, details = null) {
            const errorContainer = document.getElementById('error-container');
            const errorId = `err-${Date.now()}`;
            const errorDiv = document.createElement('div');
            errorDiv.id = errorId;
            errorDiv.className = 'error-message mb-2 fade-in';
            errorDiv.innerHTML = `<div class="flex justify-between items-center"><span><strong>错误:</strong> ${message}</span><button onclick="document.getElementById('${errorId}').remove()" class="text-lg font-bold">&times;</button></div>${details ? `<div class="mt-2 text-sm">${details}</div>` : ''}`;
            errorContainer.appendChild(errorDiv);
            setTimeout(() => {
                errorDiv.remove();
            }, 6000);
        }

        function showSuccess(message) {
            const errorContainer = document.getElementById('error-container');
            const successId = `success-${Date.now()}`;
            const successDiv = document.createElement('div');
            successDiv.id = successId;
            successDiv.className = 'fade-in p-4 mb-2 rounded-lg bg-green-50 border border-green-200 text-green-800';
            successDiv.innerHTML = `<div class="flex justify-between items-center"><span><strong>成功:</strong> ${message}</span><button onclick="document.getElementById('${successId}').remove()" class="text-lg font-bold">&times;</button></div>`;
            errorContainer.appendChild(successDiv);
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function updateStatus(text) {
            const statusEl = document.getElementById('status-display');
            if (statusEl) statusEl.textContent = text;
        }

        // === 确认模态框逻辑 ===
        let confirmCallback = null;
        const showConfirmModal = (title, body, onConfirm) => {
            ui.confirmModal.title.textContent = title;
            ui.confirmModal.body.textContent = body;
            confirmCallback = onConfirm;
            ui.confirmModal.el.style.display = 'flex';
        };

        const hideConfirmModal = () => {
            ui.confirmModal.el.style.display = 'none';
            confirmCallback = null;
        };

        ui.confirmModal.confirmBtn.addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideConfirmModal();
        });

        ui.confirmModal.cancelBtn.addEventListener('click', hideConfirmModal);

        // === 认证状态管理 ===
        onAuthStateChanged(auth, (user) => {
            ui.loadingOverlay.style.display = 'flex';
            if (user) {
                currentUser = user;
                ui.loginView.style.display = 'none';
                ui.appView.style.display = 'block';
                ui.userName.textContent = user.displayName;
                ui.userAvatar.src = user.photoURL;
                setupStudentListener();
            } else {
                currentUser = null;
                if (studentsUnsubscribe) studentsUnsubscribe();
                ui.appView.style.display = 'none';
                ui.loginView.style.display = 'block';
                ui.loadingOverlay.style.display = 'none';
                updateStatus('请点击按钮登录');
            }
        });

        // === 登录和登出处理 ===
        document.getElementById('login-btn').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => showError('登录失败', err.message));
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).catch(err => showError('登出失败', err.message));
        });

        // === Firestore 数据监听 ===
        function setupStudentListener() {
            if (studentsUnsubscribe) {
                studentsUnsubscribe();
            }
            const studentsColRef = collection(db, 'users', currentUser.uid, 'students');
            studentsUnsubscribe = onSnapshot(studentsColRef, 
                (snapshot) => {
                    localStudentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateStudentSelector();
                    renderStudentContent();
                    updateStatus(`已加载 ${localStudentsData.length} 个学生`);
                    ui.loadingOverlay.style.display = 'none';
                },
                (error) => {
                    console.error("监听学生数据失败:", error);
                    showError('加载数据失败', error.message);
                    ui.loadingOverlay.style.display = 'none';
                }
            );
        }

        // === UI 更新函数 ===
        function updateStudentSelector() {
            const currentFocus = document.activeElement;
            ui.studentSelector.innerHTML = '';
            if (localStudentsData.length === 0) {
                ui.studentSelector.innerHTML = '<option disabled selected>请先添加学生</option>';
                selectedStudentId = null;
                return;
            }
            localStudentsData.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                ui.studentSelector.appendChild(option);
            });
            if (selectedStudentId && localStudentsData.some(s => s.id === selectedStudentId)) {
                ui.studentSelector.value = selectedStudentId;
            } else {
                selectedStudentId = localStudentsData[0]?.id || null;
            }
        }

        function renderStudentContent() {
            const container = ui.studentContentContainer;
            const template = document.getElementById('student-content-template');
            container.innerHTML = '';
            if (!selectedStudentId) return;
            const studentData = localStudentsData.find(s => s.id === selectedStudentId);
            if (!studentData || !Array.isArray(studentData.semesters)) return;
            const clone = template.content.cloneNode(true);
            const wrapper = clone.querySelector('div');
            studentData.semesters.forEach((semesterData, index) => {
                const semesterEl = createSemesterElement(semesterData, index);
                wrapper.appendChild(semesterEl);
            });
            container.appendChild(clone);
            updateOverallCalculations();
        }

        function createSemesterElement(semesterData, semesterIndex) {
            const semesterTemplate = document.getElementById('semester-template').content.cloneNode(true);
            const semesterEl = semesterTemplate.querySelector('.semester-section');
            semesterEl.dataset.semesterIndex = semesterIndex;
            
            // 智能生成学期名称
            const semesterName = semesterData.name || `第 ${semesterIndex + 1} 学期`;
            semesterEl.querySelector('.semester-name-input').value = semesterName;
            semesterEl.querySelector('.semester-name-input').dataset.semesterIndex = semesterIndex;

            const coursesContainer = semesterEl.querySelector('.courses-container');
            if (Array.isArray(semesterData.courses)) {
                semesterData.courses.forEach((courseData, courseIndex) => {
                    const courseEl = createCourseElement(courseData, semesterIndex, courseIndex);
                    coursesContainer.appendChild(courseEl);
                });
            }

            // 更新学期计算
            updateSemesterCalculations(semesterEl);
            return semesterEl;
        }

        function createCourseElement(courseData, semesterIndex, courseIndex) {
            const courseTemplate = document.getElementById('course-template').content.cloneNode(true);
            const courseEl = courseTemplate.querySelector('.course-card');
            courseEl.dataset.semesterIndex = semesterIndex;
            courseEl.dataset.courseIndex = courseIndex;
            courseEl.querySelector('.course-name-input').value = courseData.name;
            courseEl.querySelector('.course-credits-input').value = courseData.credits || '';
            courseEl.querySelector('.target-grade-input').value = courseData.targetGrade || '';
            const assignmentsContainer = courseEl.querySelector('.assignments-container');
            if(Array.isArray(courseData.assignments)) {
                courseData.assignments.forEach((assignmentData, assignmentIndex) => {
                    const assignmentEl = createAssignmentElement(assignmentData, assignmentIndex);
                    assignmentsContainer.appendChild(assignmentEl);
                });
            }
            updateCourseCalculations(courseEl);
            return courseEl;
        }

        function createAssignmentElement(assignmentData, assignmentIndex) {
            const assignmentTemplate = document.getElementById('assignment-template').content.cloneNode(true);
            const assignmentEl = assignmentTemplate.querySelector('.assignment-row');
            assignmentEl.dataset.assignmentIndex = assignmentIndex;
            assignmentEl.querySelector('.assignment-name-input').value = assignmentData.name || '';
            assignmentEl.querySelector('.assignment-type-input').value = assignmentData.type || '';
            assignmentEl.querySelector('.assignment-weight-input').value = assignmentData.weight || '';
            assignmentEl.querySelector('.assignment-score-input').value = assignmentData.score || '';
            assignmentEl.querySelector('.assignment-max-score-input').value = assignmentData.maxScore || 100;
            return assignmentEl;
        }

        // === 计算逻辑 ===
        function scoreToGpaPoint(score) {
            if (score >= 95) return 4.0;
            if (score >= 90) return 3.7;
            if (score >= 85) return 3.3;
            if (score >= 80) return 3.0;
            if (score >= 75) return 2.7;
            if (score >= 70) return 2.3;
            if (score >= 65) return 2.0;
            if (score >= 60) return 1.7;
            return 0.0;
        }

        function updateCourseCalculations(courseEl) {
            const { semesterIndex, courseIndex } = courseEl.dataset;
            const studentData = localStudentsData.find(s => s.id === selectedStudentId);
            if (!studentData) return;
            const courseData = studentData.semesters[semesterIndex].courses[courseIndex];
            let totalWeight = 0, gradedWeight = 0, currentWeightedScore = 0;
            courseData.assignments.forEach(a => {
                const weight = parseFloat(a.weight) || 0;
                totalWeight += weight;
                if (a.score !== '' && a.score !== null) {
                    const score = parseFloat(a.score) || 0;
                    const maxScore = parseFloat(a.maxScore) || 100;
                    gradedWeight += weight;
                    currentWeightedScore += (score / maxScore) * weight;
                }
            });
            const totalWeightDisplay = courseEl.querySelector('.total-weight-display');
            totalWeightDisplay.textContent = `${totalWeight.toFixed(1)}%`;
            totalWeightDisplay.style.color = totalWeight > 100.01 ? '#ef4444' : (Math.abs(totalWeight - 100) < 0.01 ? '#10b981' : '#6b7280');

            let finalGrade = 0;
            if (gradedWeight > 0) {
                finalGrade = (currentWeightedScore / gradedWeight) * 100;
                courseEl.querySelector('.current-grade-display').textContent = `${finalGrade.toFixed(2)}`;
            } else {
                courseEl.querySelector('.current-grade-display').textContent = 'N/A';
            }
            courseData.finalGrade = finalGrade;

            // === 新增：计算对学期总分的贡献分数 ===
            const courseWeight = parseFloat(courseData.credits) || 0; // 这里的credits字段现在用作“权重”
            const contributionToSemester = (finalGrade * courseWeight) / 100; // 贡献分数 = 得分 * (权重/100)
            const contributionDisplay = courseEl.querySelector('.contribution-display');
            contributionDisplay.textContent = `${contributionToSemester.toFixed(2)} 分`;

            // 更新目标分析
            const targetAnalysisDisplay = courseEl.querySelector('.target-analysis-display');
            const targetGrade = parseFloat(courseData.targetGrade);
            if (!isNaN(targetGrade)) {
                const remainingWeight = totalWeight - gradedWeight;
                if (remainingWeight > 0.01) {
                    if (totalWeight > 100.01) {
                        targetAnalysisDisplay.textContent = '权重总和超过100%';
                    } else {
                        const pointsNeeded = (targetGrade * totalWeight / 100) - currentWeightedScore;
                        if (pointsNeeded <= 0) {
                            targetAnalysisDisplay.innerHTML = `已达到目标!`;
                        } else {
                            const requiredAvg = (pointsNeeded / remainingWeight) * 100;
                            targetAnalysisDisplay.innerHTML = `剩余项目需 <span class="font-bold ${requiredAvg > 100.01 ? 'text-red-500' : 'text-blue-600'}">${requiredAvg.toFixed(2)}%</span>`;
                        }
                    }
                } else if (totalWeight > 0) {
                    targetAnalysisDisplay.textContent = finalGrade >= targetGrade ? '恭喜！已达到目标！' : '很遗憾，未达到目标。';
                } else {
                    targetAnalysisDisplay.textContent = '请输入权重以分析';
                }
            } else {
                targetAnalysisDisplay.textContent = '输入目标分以分析';
            }
        }

        function updateSemesterCalculations(semesterEl) {
            const { semesterIndex } = semesterEl.dataset;
            const studentData = localStudentsData.find(s => s.id === selectedStudentId);
            if (!studentData) return;
            const semesterData = studentData.semesters[semesterIndex];
            let totalWeight = 0; // 总权重 (所有课程权重之和)
            let weightedScoreSum = 0; // 加权分数总和

            semesterData.courses.forEach(course => {
                const weight = parseFloat(course.credits) || 0; // 课程权重
                if (course.finalGrade !== undefined && course.finalGrade > 0 && weight > 0) {
                    totalWeight += weight;
                    weightedScoreSum += course.finalGrade * weight; // 累加 (得分 * 权重)
                }
            });

            const weightedScoreDisplay = semesterEl.querySelector('.semester-weighted-score-display');
            if (totalWeight > 0) {
                // 学期总分 = 所有(课程得分 * 课程权重)之和 / 100
                const semesterScore = weightedScoreSum / 100;
                weightedScoreDisplay.textContent = semesterScore.toFixed(2);
            } else {
                weightedScoreDisplay.textContent = 'N/A';
            }
        }

        function updateOverallCalculations() {
            if (localStudentsData.length === 0 || !selectedStudentId) return;
            const studentData = localStudentsData.find(s => s.id === selectedStudentId);
            if (!studentData || !Array.isArray(studentData.semesters)) return;
            let totalWeight = 0;
            let weightedScoreSum = 0;
            studentData.semesters.forEach(semester => {
                if (Array.isArray(semester.courses)) {
                    semester.courses.forEach(course => {
                        const weight = parseFloat(course.credits) || 0;
                        if (course.finalGrade !== undefined && course.finalGrade > 0 && weight > 0) {
                            totalWeight += weight;
                            weightedScoreSum += course.finalGrade * weight;
                        }
                    });
                }
            });
            if (totalWeight > 0) {
                ui.overall.score.textContent = (weightedScoreSum / 100).toFixed(2);
            } else {
                ui.overall.score.textContent = 'N/A';
            }
        }

        // === 事件监听器 ===
        document.getElementById('add-student-btn').addEventListener('click', async () => {
            if (!currentUser) { showError('请先登录'); return; }
            const name = prompt('请输入学生姓名:');
            if (!name || name.trim() === '') return;
            const newStudent = {
                id: Date.now().toString(),
                name: name.trim(),
                semesters: []
            };
            try {
                await setDoc(doc(db, 'users', currentUser.uid, 'students', newStudent.id), newStudent);
                showSuccess('学生添加成功！');
            } catch (e) {
                showError('添加学生失败', e.message);
            }
        });

        document.getElementById('add-semester-btn').addEventListener('click', () => {
            if (!selectedStudentId || !currentUser) { showError('请先选择或添加一个学生。'); return; }
            let studentData = JSON.parse(JSON.stringify(localStudentsData.find(s => s.id === selectedStudentId)));
            if (!studentData) return;
            studentData.semesters.push({ courses: [] });
            updateStudentData(studentData.semesters);
            showSuccess('新学期已添加！');
        });

        ui.studentSelector.addEventListener('change', (e) => {
            selectedStudentId = e.target.value;
            renderStudentContent();
        });

        ui.studentContentContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            let studentData = JSON.parse(JSON.stringify(localStudentsData.find(s => s.id === selectedStudentId)));
            if (!studentData) return;

            const courseCard = target.closest('.course-card');
            if (courseCard) {
                const { semesterIndex, courseIndex } = courseCard.dataset;
                if (target.classList.contains('remove-course-btn')) {
                    showConfirmModal('确认删除课程', '确定要删除这门课程吗？此操作无法撤销。', () => {
                        studentData.semesters[semesterIndex].courses.splice(courseIndex, 1);
                        updateStudentData(studentData.semesters);
                        showSuccess('课程删除成功！');
                    });
                } else if (target.classList.contains('add-assignment-btn')) {
                    studentData.semesters[semesterIndex].courses[courseIndex].assignments.push({ name: '', type: '', weight: '', score: '', maxScore: 100 });
                    updateStudentData(studentData.semesters);
                    showSuccess('评分项目已添加！');
                } else if (target.classList.contains('remove-assignment-btn')) {
                    const { semesterIndex, courseIndex, assignmentIndex } = target.closest('.assignment-row').dataset;
                    showConfirmModal('确认删除评分项目', '确定要删除这个评分项目吗？此操作无法撤销。', () => {
                        studentData.semesters[semesterIndex].courses[courseIndex].assignments.splice(assignmentIndex, 1);
                        updateStudentData(studentData.semesters);
                        showSuccess('评分项目已删除！');
                    });
                }
            } else if (target.classList.contains('remove-semester-btn')) {
                const { semesterIndex } = target.closest('.semester-section').dataset;
                showConfirmModal('确认删除学期', '确定要删除这个学期吗？该学期下的所有课程和成绩都将被删除，此操作无法撤销。', async () => {
                    studentData.semesters.splice(semesterIndex, 1);
                    await updateStudentData(studentData.semesters);
                    showSuccess('学期已删除！');
                });
            }
        });

        ui.studentContentContainer.addEventListener('input', (e) => {
            const target = e.target;
            const semesterEl = target.closest('.semester-section');
            const courseCard = target.closest('.course-card');
            const assignmentRow = target.closest('.assignment-row');
            let studentData = JSON.parse(JSON.stringify(localStudentsData.find(s => s.id === selectedStudentId)));
            if (!studentData) return;

            if (semesterEl && target.classList.contains('semester-name-input')) {
                const { semesterIndex } = semesterEl.dataset;
                studentData.semesters[semesterIndex].name = target.value;
                updateStudentData(studentData.semesters);
            } else if (courseCard) {
                const { semesterIndex, courseIndex } = courseCard.dataset;
                const courseData = studentData.semesters[semesterIndex].courses[courseIndex];
                if (target.classList.contains('course-name-input')) {
                    courseData.name = target.value;
                } else if (target.classList.contains('course-credits-input')) {
                    // 保存“权重”而不是“学分”
                    courseData.credits = target.value;
                } else if (target.classList.contains('target-grade-input')) {
                    courseData.targetGrade = target.value;
                } else if (assignmentRow) {
                    const { assignmentIndex } = assignmentRow.dataset;
                    const assignmentData = courseData.assignments[assignmentIndex];
                    if (target.classList.contains('assignment-name-input')) assignmentData.name = target.value;
                    if (target.classList.contains('assignment-type-input')) assignmentData.type = target.value;
                    if (target.classList.contains('assignment-weight-input')) assignmentData.weight = target.value;
                    if (target.classList.contains('assignment-score-input')) assignmentData.score = target.value;
                    if (target.classList.contains('assignment-max-score-input')) assignmentData.maxScore = target.value;
                }
                updateStudentData(studentData.semesters);
            }
        });

        async function updateStudentData(updatedSemesters) {
            if (!selectedStudentId || !currentUser) return;
            const studentRef = doc(db, 'users', currentUser.uid, 'students', selectedStudentId);
            const studentData = localStudentsData.find(s => s.id === selectedStudentId);
            if (!studentData) return;
            studentData.semesters = updatedSemesters;
            try {
                await setDoc(studentRef, studentData);
            } catch (e) {
                showError('保存数据失败', e.message);
            }
        }

        // === 导出功能 ===
        document.getElementById('export-menu-btn').addEventListener('click', () => {
            ui.exportMenu.options.classList.toggle('hidden');
        });

        document.getElementById('export-xlsx-btn').addEventListener('click', () => {
            if (!selectedStudentId) { showError('请先选择一个学生。'); return; }
            const studentData = localStudentsData.find(s => s.id === selectedStudentId);
            if (!studentData) return;
            const wb = XLSX.utils.book_new();
            studentData.semesters.forEach((semester, sIndex) => {
                const data = [['评分项目', '类型', '权重', '得分', '满分']];
                semester.courses.forEach(course => {
                    if (Array.isArray(course.assignments)) {
                        course.assignments.forEach(ass => {
                            data.push([ass.name, ass.type, ass.weight, ass.score, ass.maxScore]);
                        });
                    }
                    data.push([]); // 空行分隔课程
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, `学期${sIndex + 1}`);
            });
            XLSX.writeFile(wb, `${studentData.name}_成绩表.xlsx`);
            ui.exportMenu.options.classList.add('hidden');
        });

        document.getElementById('export-json-btn').addEventListener('click', () => {
            if (!selectedStudentId) { showError('请先选择一个学生。'); return; }
            const studentData = localStudentsData.find(s => s.id === selectedStudentId);
            if (!studentData) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(studentData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `${studentData.name}_成绩数据.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            ui.exportMenu.options.classList.add('hidden');
        });

        // === 清空所有数据 ===
        document.getElementById('clear-all-btn').addEventListener('click', () => {
            showConfirmModal('确认清空所有数据', '确定要清空所有学生、学期和成绩数据吗？此操作无法撤销，请谨慎操作！', async () => {
                if (!currentUser) return;
                const studentsColRef = collection(db, 'users', currentUser.uid, 'students');
                try {
                    const snapshot = await getDocs(studentsColRef);
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    showSuccess('所有数据已清空。');
                } catch (e) {
                    showError('清空数据失败', e.message);
                }
            });
        });

        // === 初始化 ===
        try {
            updateStatus('加载中...');
        } catch (error) {
            console.error("初始化失败:", error);
            showError('应用初始化失败', error.message);
            updateStatus('初始化失败，请刷新页面');
        }
    </script>
</body>
</html>
