<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>利兹大学学位等级计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
            background-color: #f8f9fa;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .form-input {
            border: 1px solid #d1d5db;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .score-1st { color: #10b981; } /* Green */
        .score-2-1 { color: #3b82f6; } /* Blue */
        .score-2-2 { color: #f59e0b; } /* Amber */
        .score-3rd { color: #ef4444; } /* Red */
        .score-fail { color: #7f1d1d; } /* Dark Red */
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">利兹大学 (University of Leeds)</h1>
            <p class="text-lg text-gray-600 mt-2">学士学位等级计算器 (Bachelor Degree Classification)</p>
        </header>

        <!-- Import/Export Buttons -->
        <div class="card p-4 mb-8 flex justify-center items-center space-x-4">
            <input type="file" id="import-input" class="hidden" accept=".xlsx, .xls, .csv">
            <button id="download-template-btn" class="btn btn-secondary">下载模板</button>
            <button id="import-btn" class="btn btn-primary">导入成绩</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Penultimate Year Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">倒数第二学年 (Penultimate Year)</h2>
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b-2">
                            <th class="p-2 w-2/5">模块名称</th>
                            <th class="p-2">分数</th>
                            <th class="p-2">学分</th>
                            <th class="p-2"></th>
                        </tr>
                    </thead>
                    <tbody id="penultimate-year-modules">
                        <!-- Module rows will be inserted here -->
                    </tbody>
                </table>
                <button id="add-penultimate-module" class="btn btn-primary mt-4 w-full">添加模块</button>
            </div>

            <!-- Final Year Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">最后一学年 (Final Year)</h2>
                <table class="w-full text-left">
                    <thead>
                         <tr class="border-b-2">
                            <th class="p-2 w-2/5">模块名称</th>
                            <th class="p-2">分数</th>
                            <th class="p-2">学分</th>
                            <th class="p-2 text-sm">技能发现?</th>
                            <th class="p-2"></th>
                        </tr>
                    </thead>
                    <tbody id="final-year-modules">
                        <!-- Module rows will be inserted here -->
                    </tbody>
                </table>
                <button id="add-final-module" class="btn btn-primary mt-4 w-full">添加模块</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card p-8 mt-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">计算结果</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-600">倒数第二学年平均分</h3>
                    <p id="penultimate-average" class="text-4xl font-extrabold text-gray-700 mt-2">0.00</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-600">最后一学年平均分</h3>
                    <p id="final-average" class="text-4xl font-extrabold text-gray-700 mt-2">0.00</p>
                </div>
                <div class="md:col-span-3 border-t pt-6 mt-6 md:border-t-0 md:pt-0 md:mt-0 md:border-l md:pl-6">
                    <h3 class="text-xl font-bold text-gray-600">最终学位加权平均分</h3>
                    <p class="text-gray-500 text-sm">(Y2 Avg * 1 + Y3 Avg * 2) / 3</p>
                    <p id="final-classification-score" class="text-6xl font-extrabold text-blue-600 my-3">0.00</p>
                    <p id="final-classification-grade" class="text-3xl font-bold">-</p>
                </div>
            </div>
        </div>
        
        <!-- Explanation Section -->
        <div class="card p-6 mt-8 text-gray-700 text-sm">
             <h3 class="text-lg font-bold mb-3">计算规则说明</h3>
             <ul class="list-disc list-inside space-y-2">
                 <li>学位等级根据倒数第二学年 (Penultimate Year) 和最后一学年 (Final Year) 的加权平均分计算。</li>
                 <li>最终加权分 = (倒数第二学年平均分 × 1 + 最后一学年平均分 × 2) / 3。</li>
                 <li>学年平均分 = (所有模块的[分数 × 学分]之和) / (该学年总学分)。</li>
                 <li><strong>技能发现模块 (Skills Discovery Modules):</strong> 如果在最后一学年修读了此类模块，其分数和学分将被计入倒数第二学年用于计算。</li>
                 <li class="mt-4"><strong>学位等级划分:</strong>
                     <ul class="list-inside list-disc ml-4 mt-1">
                        <li><span class="font-bold score-1st">70+</span>: First Class Honours (1st)</li>
                        <li><span class="font-bold score-2-1">60-69</span>: Upper Second Class Honours (2:1)</li>
                        <li><span class="font-bold score-2-2">50-59</span>: Lower Second Class Honours (2:2)</li>
                        <li><span class="font-bold score-3rd">40-49</span>: Third Class Honours (3rd)</li>
                        <li><span class="font-bold score-fail">&lt;40</span>: Fail</li>
                     </ul>
                 </li>
                 <li>本计算器仅供参考，最终结果以学校官方发布为准。</li>
             </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const penultimateBody = document.getElementById('penultimate-year-modules');
            const finalBody = document.getElementById('final-year-modules');
            const importInput = document.getElementById('import-input');

            // Add Module Buttons
            document.getElementById('add-penultimate-module').addEventListener('click', () => addModuleRow(penultimateBody, false));
            document.getElementById('add-final-module').addEventListener('click', () => addModuleRow(finalBody, true));

            // Import/Export Buttons
            document.getElementById('import-btn').addEventListener('click', () => importInput.click());
            document.getElementById('download-template-btn').addEventListener('click', downloadTemplate);
            importInput.addEventListener('change', handleImport);

            function createModuleRow(isFinalYear, data = {}) {
                const tr = document.createElement('tr');
                tr.className = 'module-row';
                let innerHTML = `
                    <td class="p-2"><input type="text" class="module-name-input form-input w-full p-2 rounded-md" placeholder="模块名称" value="${data.name || ''}"></td>
                    <td class="p-2"><input type="number" min="0" max="100" class="mark-input form-input w-full p-2 rounded-md" placeholder="分数" value="${data.mark || ''}"></td>
                    <td class="p-2"><input type="number" min="0" class="credit-input form-input w-full p-2 rounded-md" placeholder="学分" value="${data.credits || ''}"></td>
                `;
                if (isFinalYear) {
                    innerHTML += `
                        <td class="p-2 text-center"><input type="checkbox" class="discovery-checkbox h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${data.isDiscovery ? 'checked' : ''}></td>
                    `;
                } else {
                     innerHTML += '<td class="p-2"></td>'; // Placeholder for alignment
                }
                innerHTML += `
                    <td class="p-2 text-right"><button class="remove-row-btn btn btn-danger p-2">×</button></td>
                `;
                tr.innerHTML = innerHTML;
                return tr;
            }

            function addModuleRow(tbody, isFinalYear, data) {
                const row = createModuleRow(isFinalYear, data);
                tbody.appendChild(row);
                attachRowListeners(row);
                // Add a few default rows on first click if no data is provided
                if (!data && tbody.children.length === 1) {
                    for(let i=0; i<3; i++) {
                         const extraRow = createModuleRow(isFinalYear);
                         tbody.appendChild(extraRow);
                         attachRowListeners(extraRow);
                    }
                }
            }
            
            function attachRowListeners(row) {
                row.querySelector('.remove-row-btn').addEventListener('click', () => {
                    row.remove();
                    calculateAll();
                });
                row.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', calculateAll);
                });
            }

            function calculateYearAverage(moduleRows) {
                let totalWeightedScore = 0;
                let totalCredits = 0;
                moduleRows.forEach(row => {
                    const mark = parseFloat(row.querySelector('.mark-input').value) || 0;
                    const credit = parseFloat(row.querySelector('.credit-input').value) || 0;
                    if (mark > 0 && credit > 0) {
                        totalWeightedScore += mark * credit;
                        totalCredits += credit;
                    }
                });
                return totalCredits > 0 ? totalWeightedScore / totalCredits : 0;
            }

            function calculateAll() {
                const penultimateRows = Array.from(penultimateBody.querySelectorAll('.module-row'));
                const finalRows = Array.from(finalBody.querySelectorAll('.module-row'));

                const discoveryModules = [];
                const standardFinalModules = [];

                finalRows.forEach(row => {
                    if (row.querySelector('.discovery-checkbox').checked) {
                        discoveryModules.push(row);
                    } else {
                        standardFinalModules.push(row);
                    }
                });

                const penultimateWithDiscoveryRows = penultimateRows.concat(discoveryModules);

                const penultimateAvg = calculateYearAverage(penultimateWithDiscoveryRows);
                const finalAvg = calculateYearAverage(standardFinalModules);

                document.getElementById('penultimate-average').textContent = penultimateAvg.toFixed(2);
                document.getElementById('final-average').textContent = finalAvg.toFixed(2);
                
                const classificationScore = (penultimateAvg * 1 + finalAvg * 2) / 3;
                const scoreDisplay = document.getElementById('final-classification-score');
                const gradeDisplay = document.getElementById('final-classification-grade');

                if (isNaN(classificationScore) || classificationScore === 0) {
                    scoreDisplay.textContent = '0.00';
                    gradeDisplay.textContent = '-';
                    gradeDisplay.className = 'text-3xl font-bold';
                    return;
                }

                scoreDisplay.textContent = classificationScore.toFixed(2);

                let grade = '';
                let gradeClass = '';
                if (classificationScore >= 70) {
                    grade = 'First Class Honours (1st)';
                    gradeClass = 'score-1st';
                } else if (classificationScore >= 60) {
                    grade = 'Upper Second Class Honours (2:1)';
                    gradeClass = 'score-2-1';
                } else if (classificationScore >= 50) {
                    grade = 'Lower Second Class Honours (2:2)';
                    gradeClass = 'score-2-2';
                } else if (classificationScore >= 40) {
                    grade = 'Third Class Honours (3rd)';
                    gradeClass = 'score-3rd';
                } else {
                    grade = 'Fail';
                    gradeClass = 'score-fail';
                }
                gradeDisplay.textContent = grade;
                gradeDisplay.className = `text-3xl font-bold ${gradeClass}`;
            }

            function downloadTemplate() {
                const headers = ["Year", "Module Name", "Mark", "Credits", "Is Discovery Module"];
                const sampleData = [
                    { "Year": "Penultimate", "Module Name": "例如: COMP2211", "Mark": 75, "Credits": 20, "Is Discovery Module": "No" },
                    { "Year": "Penultimate", "Module Name": "例如: COMP2931", "Mark": 68, "Credits": 10, "Is Discovery Module": "No" },
                    { "Year": "Final", "Module Name": "例如: COMP3211", "Mark": 80, "Credits": 40, "Is Discovery Module": "No" },
                    { "Year": "Final", "Module Name": "例如: FOAH1000", "Mark": 72, "Credits": 10, "Is Discovery Module": "Yes" },
                ];
                const worksheet = XLSX.utils.json_to_sheet(sampleData, { header: headers });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Leeds GPA Template");
                XLSX.writeFile(workbook, `leeds_gpa_template.xlsx`);
            }

            function handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        
                        processImportedData(json);

                    } catch (err) {
                        alert("文件处理失败，请确保文件格式正确。错误: " + err.message);
                    } finally {
                        event.target.value = ''; // Reset input
                    }
                };
                reader.onerror = () => {
                    alert("无法读取文件。");
                    event.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            }

            function processImportedData(data) {
                // Clear existing rows
                penultimateBody.innerHTML = '';
                finalBody.innerHTML = '';

                data.forEach(row => {
                    const moduleData = {
                        name: row["Module Name"],
                        mark: row["Mark"],
                        credits: row["Credits"],
                        isDiscovery: (row["Is Discovery Module"] || '').toLowerCase() === 'yes'
                    };

                    const year = (row["Year"] || '').toLowerCase();
                    if (year.includes('penultimate')) {
                        addModuleRow(penultimateBody, false, moduleData);
                    } else if (year.includes('final')) {
                        addModuleRow(finalBody, true, moduleData);
                    }
                });

                calculateAll();
            }
            
            // Initial setup
            addModuleRow(penultimateBody, false);
            addModuleRow(finalBody, true);
        });
    </script>
</body>
</html>
